# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# LogMeIn - Docker Swarm Cluster
# 1 Manager + 2 Workers
#
# Usage:
#   vagrant up              - Start all VMs and configure the Swarm
#   vagrant ssh manager     - SSH into the manager node
#   vagrant ssh worker1     - SSH into worker 1
#   vagrant ssh worker2     - SSH into worker 2
#   vagrant destroy -f      - Destroy all VMs
#

MANAGER_IP = "192.168.56.10"
WORKER1_IP = "192.168.56.11"
WORKER2_IP = "192.168.56.12"

BOX_IMAGE = "ubuntu/jammy64"
BOX_MEMORY = "2048"
BOX_CPUS = 2

Vagrant.configure("2") do |config|

  # ============================================
  # Manager Node
  # ============================================
  config.vm.define "manager", primary: true do |manager|
    manager.vm.box = BOX_IMAGE
    manager.vm.hostname = "swarm-manager"
    manager.vm.network "private_network", ip: MANAGER_IP

    manager.vm.provider "virtualbox" do |vb|
      vb.memory = BOX_MEMORY
      vb.cpus = BOX_CPUS
      vb.name = "logmein-swarm-manager"
    end

    # Install Docker
    manager.vm.provision "shell", path: "scripts/install-docker.sh"

    # Initialize Swarm as manager
    manager.vm.provision "shell", inline: <<-SHELL
      echo "Initializing Docker Swarm on manager..."
      docker swarm init --advertise-addr #{MANAGER_IP}

      # Save the join token for workers
      docker swarm join-token worker -q > /vagrant/worker-token.txt
      echo "Swarm manager initialized. Worker token saved."

      # Create the overlay networks
      docker network create --driver overlay --encrypted logmein-backend-network || true
      docker network create --driver overlay --encrypted logmein-frontend-network || true

      # Create Docker secrets
      echo "logs_password" | docker secret create db_password - || true

      echo "Manager setup complete!"
      echo "Manager IP: #{MANAGER_IP}"
      docker node ls
    SHELL
  end

  # ============================================
  # Worker Nodes
  # ============================================
  (1..2).each do |i|
    config.vm.define "worker#{i}" do |worker|
      worker_ip = i == 1 ? WORKER1_IP : WORKER2_IP

      worker.vm.box = BOX_IMAGE
      worker.vm.hostname = "swarm-worker#{i}"
      worker.vm.network "private_network", ip: worker_ip

      worker.vm.provider "virtualbox" do |vb|
        vb.memory = "1536"
        vb.cpus = 1
        vb.name = "logmein-swarm-worker#{i}"
      end

      # Install Docker
      worker.vm.provision "shell", path: "scripts/install-docker.sh"

      # Join the Swarm
      worker.vm.provision "shell", inline: <<-SHELL
        echo "Worker #{i} joining the Swarm..."
        # Wait for token file to be available
        while [ ! -f /vagrant/worker-token.txt ]; do
          echo "Waiting for manager token..."
          sleep 5
        done
        TOKEN=$(cat /vagrant/worker-token.txt)
        docker swarm join --token $TOKEN #{MANAGER_IP}:2377
        echo "Worker #{i} joined the Swarm successfully!"
      SHELL
    end
  end
end
